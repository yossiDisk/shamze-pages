<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="agd-partner-manual-verification" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>×©× ×–×” ×–×•×œ ×™×•×ª×¨ - ×§×•×¤×•× ×™× ×•×”×©×•×•××ª ××—×™×¨×™×</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J5RK908M0K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-J5RK908M0K');
  </script>

  <meta name='impact-site-verification' value='860575b0-9474-438c-8bda-f30e4b2626ee'>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap');

    :root {
      --primary-green: #166534;
    }

    body {
      font-family: 'Heebo', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      color: #333;
      overflow-x: hidden;
      text-align: center;
    }

    main {
      flex: 1;
    }

    /* ×¡×’× ×•×Ÿ ×˜××‘×™× */
    .tabs-container {
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 10px;
    }

    .tab-button {
      background: none;
      border: none;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button:hover {
      color: #333;
    }

    .tab-button.active {
      color: var(--primary-green);
      border-bottom-color: var(--primary-green);
      font-weight: 700;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ×¡×’× ×•×Ÿ ×—×™×¤×•×©×™× ××—×¨×•× ×™× */
    .recent-searches-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .recent-searches-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .recent-searches-header h3 {
      margin: 0;
      flex: 1;
    }

    .copy-link-btn {
      background: var(--primary-green);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .copy-link-btn:hover {
      background: #124a2c;
      transform: translateY(-1px);
    }

    .recent-search-item {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--primary-green);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
    }

    .recent-search-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .recent-search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .recent-search-route {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .recent-search-price {
      font-weight: 700;
      color: var(--primary-green);
      font-size: 18px;
    }

    .recent-search-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #666;
      flex-wrap: wrap;
      gap: 8px;
    }

    .recent-search-dates {
      flex: 1;
      min-width: 200px;
    }

    .recent-search-time {
      font-size: 12px;
      color: #999;
      flex-shrink: 0;
    }

    .recent-search-badge {
      background: var(--primary-green);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }

    /* Responsive ×¢×‘×•×¨ ×—×™×¤×•×©×™× ××—×¨×•× ×™× */
    @media (max-width: 768px) {
      .recent-searches-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .copy-link-btn {
        align-self: center;
        padding: 10px 20px;
        font-size: 14px;
      }

      .recent-search-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .recent-search-route {
        font-size: 14px;
      }

      .recent-search-price {
        font-size: 16px;
      }

      .recent-search-details {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .recent-search-dates {
        min-width: auto;
        width: 100%;
      }

      .recent-search-time {
        align-self: flex-end;
      }
    }

    .flight-search-container {
      background: white;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .flight-inputs-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .flight-input-group {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .flight-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      text-align: right;
    }

    .flight-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      background-color: #fff;
      direction: rtl;
    }

    .flight-input:focus {
      outline: none;
      border-color: #166534;
    }

    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .suggestions-dropdown.show {
      display: block;
    }

    .suggestion-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      text-align: right;
      transition: background-color 0.2s ease;
    }

    .suggestion-item:hover {
      background-color: #f5f5f5;
    }

    .suggestion-item strong {
      color: var(--primary-green);
    }

    .suggestion-item small {
      color: #666;
      display: block;
      margin-top: 2px;
    }

    /* ×¡×’× ×•×Ÿ ×ª×•×¦××•×ª ×˜×™×¡×•×ª */
    .flight-results-container {
      margin-top: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 0 16px;
    }

    .flight-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .flight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .flight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .flight-price {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-green);
    }

    .flight-airline {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .airline-name {
      font-weight: 600;
      color: #333;
    }

    .direct-badge {
      background: #28a745;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .connecting-badge {
      background: #ffc107;
      color: #333;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .flight-body {
      padding: 12px;
    }

    .flight-route {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .flight-endpoint {
      text-align: center;
      flex: 1;
    }

    .flight-time {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    .flight-location {
      color: #666;
      margin-top: 5px;
    }

    .flight-arrow {
      flex: 0 0 auto;
      margin: 0 20px;
      color: #999;
    }

    .flight-dates {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
      color: #666;
    }

    .flight-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .flight-book-btn {
      flex: 1;
      background: var(--primary-green);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .flight-book-btn:hover {
      background-color: #124a2c;
    }

    .flight-details-toggle {
      background: #f0f0f0;
      color: #333;
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .flight-details-toggle:hover {
      background-color: #e0e0e0;
    }

    .flight-details {
      background: #f8f9fa;
      padding: 20px;
      border-top: 1px solid #e0e0e0;
      display: none;
    }

    .flight-details.show {
      display: block;
    }

    .flight-segment {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .flight-segment:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .segment-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .flight-leg {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: white;
      border-radius: 8px;
    }

    .connection-info {
      text-align: center;
      padding: 10px;
      color: #666;
      font-size: 14px;
      background: #fff3cd;
      border-radius: 8px;
      margin: 10px 0;
    }

    /* ×¤×™×œ×˜×¨×™× ×•××™×•×Ÿ */
    .filters-sort-container {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .sort-select {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    /* ×”×•×“×¢×ª ×˜×¢×™× ×” */
    .loading-flights {
      text-align: center;
      padding: 40px;
    }

    .loading-flights .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* ×¡×’× ×•× ×•×ª header */
    header a.install-button {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 150px;
      text-align: center;
    }

    header {
      background-color: var(--primary-green);
      color: white;
      padding: 10px 0;
    }

    @keyframes slow-spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin-slow {
      animation: slow-spin 3s linear infinite;
    }


    .animate-spin-slow {
      animation: slow-spin 3s linear infinite;
    }


    header .logo-container {
      display: flex;
      align-items: center;
      min-width: 0;
    }

    header h1 {
      color: white;
      font-size: 1.25rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ×¡×’× ×•× ×•×ª ××•×¦×¨×™× */
    .search-input {
      width: 100%;
      padding: 12px 30px 12px 12px;
      border: 1px solid #999;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #555;
    }

    .clear-search {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #999;
      font-size: 18px;
    }

    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 20px;
    }

    .coupon-button,
    .compare-button {
      background-color: var(--primary-green);
      color: white;
      padding: 15px;
      border: none;
      cursor: pointer;
      border-radius: 25px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 300px;
    }

    .coupon-button:hover,
    .coupon-button:active,
    .compare-button:hover,
    .compare-button:active {
      background-color: #124a2c;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .loading-container {
      text-align: center;
      margin: 20px 0;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    .product {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
      text-align: right;
      width: 100%;
      max-width: 300px;
    }

    .product h3 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .product h3:hover {
      text-decoration: underline;
    }

    .product p {
      margin: 5px 0;
      color: #666;
      font-size: 14px;
    }

    .comparison-result {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .comparison-item {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
      text-align: right;
      width: calc(50% - 10px);
    }

    .comparison-item h3 {
      margin-top: 0;
      font-size: 16px;
      color: #333;
    }

    .comparison-item p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    .coupon-details {
      margin-top: 10px;
    }

    .coupon-toggle {
      background-color: #f0f0f0;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .coupon-toggle:after {
      content: 'â–¼';
      font-size: 12px;
      margin-right: 5px;
      transition: transform 0.3s ease;
    }

    .coupon-toggle.active:after {
      transform: rotate(180deg);
    }

    .coupon-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .coupon-content.active {
      max-height: 500px;
    }

    .copy-icon {
      cursor: pointer;
      margin-right: 10px;
    }

    .site-link {
      color: #3498db;
      text-decoration: none;
      cursor: pointer;
      margin-top: 10px;
      display: inline-block;
    }

    .site-link:hover {
      text-decoration: underline;
    }

    .coupon-info {
      font-size: 12px;
      color: #777;
      margin-top: 5px;
    }

    .popular-searches-container {
      margin-top: 20px;
      text-align: center;
    }

    .popular-search-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .popular-search-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 14px;
    }

    .popular-search-button:hover {
      background-color: #e0e0e0;
    }

    .bg-green-600 {
      background-color: var(--primary-green);
    }

    .text-green-600 {
      color: var(--primary-green);
    }

    .hover\:bg-green-600:hover {
      background-color: var(--primary-green);
    }

    /* ×œ×•×— ×©× ×” RTL */
    .flatpickr-calendar {
      direction: rtl !important;
      text-align: right;
      max-width: 100vw !important;
      box-sizing: border-box;
    }

    .flatpickr-months {
      flex-direction: row-reverse !important;
    }

    .flatpickr-prev-month,
    .flatpickr-next-month {
      transform: rotate(180deg);
    }

    .flatpickr-current-month {
      direction: rtl;
      text-align: right;
    }

    .flatpickr-weekdays {
      direction: rtl;
    }

    /* ×ª××•× ×•×ª ×¨×§×¢ ×œ×§×œ×¤×™ ×˜×™×¡×•×ª */
    .flight-card.with-bg {
      background-size: cover;
      background-position: center;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .flight-card.with-bg::before {
      content: "";
      position: absolute;
      inset: 0;
      background-color: rgba(255, 255, 255, 0.6);
      z-index: 0;
    }

    .flight-card.with-bg>* {
      position: relative;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
      color: #000;
      z-index: 2;
    }

    /* Responsive */
    @media (max-width: 768px) {
      footer {
        display: none;
      }

      main {
        padding-bottom: 20px;
      }

      .flight-inputs-row {
        flex-direction: column;
      }

      .flight-input-group {
        max-width: 100%;
      }

      .flight-route {
        flex-direction: column;
        gap: 15px;
      }

      .flight-arrow {
        transform: rotate(90deg);
        margin: 10px 0;
      }

      .filters-sort-container {
        flex-direction: column;
        align-items: stretch;
      }

      .flight-results-container {
        grid-template-columns: 1fr;
      }

      .comparison-item {
        width: 100%;
      }
    }
  </style>
</head>

<body class="flex flex-col min-h-screen">
  <header class="bg-green-600 text-white py-2 px-4 sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
        <img
          src="https://lh3.googleusercontent.com/Sp3b24fVCvCVewv5udOP_e-qNVWGuxcZX9DEgYmKncXjeO9kp6KKCJ8NFcVs0VQNFeWo1P9p8-aYV1fDyq1Ct0ZCXec=s60"
          alt="×œ×•×’×• ×©× ×–×” ×–×•×œ ×™×•×ª×¨" class="w-10 h-10 mr-2">
        <h1 class="text-xl font-bold">×©× ×–×” ×–×•×œ ×™×•×ª×¨</h1>
      </div>
      <a href="https://chromewebstore.google.com/detail/%D7%A9%D7%9D-%D7%96%D7%94-%D7%96%D7%95%D7%9C-%D7%99%D7%95%D7%AA%D7%A8/neigoggljhfnodeneidndcflnclldnpm?hl=iw"
        class="bg-yellow-400 text-green-600 px-4 py-2 rounded-full font-bold hover:bg-yellow-300 transition duration-300 text-center install-button">
        ×”×ª×§×Ÿ ××ª ×”×ª×•×¡×£
      </a>
    </div>
  </header>

  <div class="flex flex-col flex-1">
    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- ×˜××‘×™× -->
      <div class="tabs-container">
        <button class="tab-button active" data-tab="products">×”×©×•×•××ª ××—×™×¨×™×</button>
        <button class="tab-button" data-tab="flights">×”×©×•×•××ª ×˜×™×¡×•×ª</button>
      </div>

      <!-- ×ª×•×›×Ÿ ×˜××‘ ××•×¦×¨×™× -->
      <div id="products-tab" class="tab-content active">
        <h2 class="text-3xl font-bold text-center mb-8">×—×™×¤×•×© ×§×•×¤×•× ×™× ×•×”×©×•×•××ª ××—×™×¨×™×</h2>

        <div class="bg-white p-6 rounded-lg shadow-md">
          <div class="max-w-md mx-auto">
            <div class="relative">
              <input type="text" id="searchInput"
                class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                placeholder='×œ×“×•×’×× "×”××©×‘×™×¨" ××• "××•×–× ×™×•×ª ×’×™×™××™× ×’"'>
              <span id="clearSearch"
                class="absolute left-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-400 hover:text-gray-600">âœ•</span>
              <svg class="w-6 h-6 text-gray-400 absolute right-3 top-1/2 transform -translate-y-1/2" fill="none"
                stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div id="loadingContainer" class="loading-container" style="display: none;">
          <div class="loading-spinner"></div>
          <p>××—×¤×© ××•×¦×¨×™×...</p>
        </div>

        <div id="sortContainer" class="sort-container" style="display: none;">
          <select id="sortSelect" class="sort-select">
            <option value="default">××™×•×Ÿ ×œ×¤×™</option>
            <option value="price-asc">××—×™×¨: ××”× ××•×š ×œ×’×‘×•×”</option>
            <option value="price-desc">××—×™×¨: ××”×’×‘×•×” ×œ× ××•×š</option>
          </select>
        </div>

        <div id="resultsContainer" class="button-container"></div>

        <div id="socialLinksContainer" class="mt-4 mb-4 text-center" style="display: none;">
          <p class="text-gray-700 mb-2 font-bold">×”×¦×˜×¨×¤×• ×œ×¢×“×›×•× ×™ ×§×•×¤×•× ×™×:</p>
          <div class="flex justify-center gap-4">
            <a href="https://t.me/shamzezolyoter" target="_blank"
              class="inline-flex items-center mx-2 bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9.028 20.837c-.714 0-.593-.271-.839-.949l-2.103-6.92L22.263 3.37" />
                <path d="M9.028 20.837c.552 0 .795-.252 1.105-.553l2.941-2.857-3.671-2.214" />
                <path
                  d="M9.403 15.213l8.89 6.568c1.015.56 1.748.271 2-.942l3.62-17.053c.372-1.487-.564-2.159-1.534-1.72L1.125 10.263c-1.45.582-1.443 1.392-.264 1.753l5.455 1.7L18.94 5.753c.476-.29.911-.135.553.186" />
              </svg>
              ×˜×œ×’×¨×
            </a>
            <a href="https://chat.whatsapp.com/HVpVlib1K1UFAt9KuXNgfo" target="_blank"
              class="inline-flex items-center mx-2 bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition duration-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766.001-3.187-2.575-5.77-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.748-2.874-2.494-2.961-2.61-.087-.116-.708-.94-.708-1.793s.448-1.273.607-1.446c.159-.173.346-.217.462-.217l.332.006c.106.005.249-.04.39.298.144.347.491 1.2.534 1.287.043.087.072.188.014.304-.058.116-.087.188-.173.289l-.26.304c-.087.086-.177.18-.076.354.101.174.449.741.964 1.201.662.591 1.221.774 1.394.86s.274.072.376-.043c.101-.116.433-.506.549-.677.116-.173.231-.145.39-.087s1.011.477 1.184.564.289.13.332.202c.045.72.045.419-.1.824z" />
              </svg>
              ×•×•××˜×¡××¤
            </a>
          </div>
        </div>

        <div id="compareButtonContainer" class="mt-6 text-center" style="display: none;">
          <div id="estimatedPriceContainer" class="mb-4" style="display: none;">
            <input type="number" id="estimatedPrice"
              class="w-48 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-center"
              placeholder="×”×›× ×¡ ××—×™×¨ ××©×•×¢×¨">
          </div>
          <button id="compareButton"
            class="bg-green-500 text-white px-6 py-3 rounded-full font-bold hover:bg-green-600 transition duration-300 inline-flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
              </path>
            </svg>
            ×”×©×•×•×” ××—×™×¨×™×
          </button>
        </div>
      </div>

      <!-- ×ª×•×›×Ÿ ×˜××‘ ×˜×™×¡×•×ª -->
      <div id="flights-tab" class="tab-content">
        <h2 class="text-3xl font-bold text-center mb-8">×”×©×•×•××ª ××—×™×¨×™ ×˜×™×¡×•×ª</h2>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <div class="flight-search-container">
          <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">×”×©×•×•××ª ××—×™×¨×™ ×˜×™×¡×•×ª</h2>

          <!-- ×”×¦×’×ª ×”×—×™×¤×•×©×™× ×”××—×¨×•× ×™× -->
          <div id="recentSearchesContainer" class="recent-searches-container mb-6" style="display: none;">
            <div class="recent-searches-header">
              <h3 class="text-lg font-semibold text-gray-700 mb-3">×”×ª×•×¦××” ×”×–×•×œ×” ×‘×™×•×ª×¨ ××”×—×™×¤×•×©×™× ×”××—×¨×•× ×™×:</h3>
              <button id="copyLinkBtn" class="copy-link-btn" onclick="copyCurrentPageLink(event)"
                title="×”×¢×ª×§ ×§×™×©×•×¨ ×œ×¢××•×“ ×–×”">
                ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨
              </button>
            </div>
            <div id="recentSearchesList" class="space-y-2"></div>
          </div>

          <div class="flight-inputs-row">
            <div class="flight-input-group">
              <label for="originInput">âœˆï¸ ××•×¦×</label>
              <input type="text" id="originInput" class="flight-input" placeholder="×œ×“×•×’××”: ×ª×œ ××‘×™×‘ ××• TLV">
              <div id="originSuggestions" class="suggestions-dropdown"></div>
            </div>

            <div class="flight-input-group relative">
              <label for="destinationInput">ğŸ›¬ ×™×¢×“</label>
              <input type="text" id="destinationInput" class="flight-input" placeholder="×œ×“×•×’××”: ×œ×•× ×“×•×Ÿ ××• LHR">
              <button id="randomDestinationBtn" title="×‘×—×¨ ×™×¢×“ ×¨× ×“×•××œ×™"
                class="absolute left-3 top-11 text-xl text-gray-600 hover:text-green-700 transition">
                ğŸŒ
              </button>
              <div id="destinationSuggestions" class="suggestions-dropdown"></div>
            </div>

          </div>

          <div class="flight-inputs-row">
            <div class="flight-input-group">
              <label for="dateRange">ğŸ“… ×˜×•×•×— ×ª××¨×™×›×™×</label>
              <input type="text" id="dateRange" class="flight-input" placeholder="×‘×—×¨ ×ª××¨×™×›×™×">
            </div>
          </div>

          <input type="hidden" id="dateFrom">
          <input type="hidden" id="dateTo">

          <button id="searchFlightsBtn"
            class="w-full md:w-1/2 mx-auto bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition mt-4">
            ğŸ” ×—×¤×© ×˜×™×¡×•×ª
          </button>
        </div>

        <div id="flightLoadingContainer" class="loading-flights" style="display: none;">
          <div class="spinner"></div>
          <p>××—×¤×© ×˜×™×¡×•×ª...</p>
          <p id="loadingStatus" class="text-sm text-gray-600 mt-2"></p>
        </div>

        <div id="filtersContainer" class="filters-sort-container" style="display: none;">
          <div class="filter-group">
            <input type="checkbox" id="directFlightsOnly" class="filter-checkbox">
            <label for="directFlightsOnly">×˜×™×¡×•×ª ×™×©×™×¨×•×ª ×‘×œ×‘×“</label>
          </div>

          <div class="filter-group">
            <label for="maxPriceFilter">××—×™×¨ ××§×¡×™××œ×™:</label>
            <input type="number" id="maxPriceFilter" placeholder="$" style="width: 100px;" class="flight-input">
          </div>

          <div class="filter-group">
            <label for="airlineFilter">×—×‘×¨×ª ×ª×¢×•×¤×”:</label>
            <select id="airlineFilter" class="sort-select">
              <option value="">×›×œ ×”×—×‘×¨×•×ª</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="sortFlights">××™×•×Ÿ ×œ×¤×™:</label>
            <select id="sortFlights" class="sort-select">
              <option value="price-asc">××—×™×¨ - ××”×–×•×œ ×œ×™×§×¨</option>
              <option value="price-desc">××—×™×¨ - ××”×™×§×¨ ×œ×–×•×œ</option>
              <option value="duration-asc">××©×š ×˜×™×¡×” - ××”×§×¦×¨ ×œ××¨×•×š</option>
              <option value="nights">××¡×¤×¨ ×œ×™×œ×•×ª</option>
            </select>
          </div>
        </div>

        <div id="flightSearchStatus" class="text-center text-sm text-gray-600 mt-4" style="display: none;"></div>

        <div id="flightResultsContainer" class="flight-results-container mt-8"></div>
      </div>
    </main>

    <footer class="bg-green-600 text-white py-8">
      <div class="container mx-auto text-center">
        <div class="flex flex-wrap justify-center mb-4">
          <a href="./legal/privacy.html" class="mx-2 hover:underline">××“×™× ×™×•×ª ×¤×¨×˜×™×•×ª</a>
          <a href="./legal/terms.html" class="mx-2 hover:underline">×ª× ××™ ×©×™××•×©</a>
          <a href="mailto:shamzezolyoter@gmail.com" class="mx-2 hover:underline">×¦×•×¨ ×§×©×¨</a>
        </div>
        <p>Â© 2024 ×©× ×–×” ×–×•×œ ×™×•×ª×¨ - ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª</p>
      </div>
    </footer>
  </div>

  <script>
    // ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ URL parameters
    function updateUrlWithFlightParams(origin, destination, dateFrom, dateTo) {
      const params = new URLSearchParams();

      if (origin && origin.code) {
        params.set('origin', origin.code);
        params.set('originName', origin.nameHeb);
      }
      if (destination && destination.code) {
        params.set('destination', destination.code);
        params.set('destinationName', destination.nameHeb);
      }
      if (dateFrom) {
        params.set('dateFrom', dateFrom);
      }
      if (dateTo) {
        params.set('dateTo', dateTo);
      }

      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.pushState({ path: newUrl }, '', newUrl);
    }

    function getFlightParamsFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        origin: urlParams.get('origin'),
        originName: urlParams.get('originName'),
        destination: urlParams.get('destination'),
        destinationName: urlParams.get('destinationName'),
        dateFrom: urlParams.get('dateFrom'),
        dateTo: urlParams.get('dateTo')
      };
    }

    function hasFlightParams() {
      const params = getFlightParamsFromUrl();
      return params.origin && params.destination && params.dateFrom && params.dateTo;
    }

    // ×”×’×“×¨×ª flatpickr
    flatpickr("#dateRange", {
      mode: "range",
      minDate: new Date().fp_incr(1),
      showMonths: 2,
      dateFormat: "Y-m-d",
      position: "auto right",
      locale: {
        firstDayOfWeek: 0,
        isRtl: true,
        weekdays: {
          shorthand: ['×', '×‘', '×’', '×“', '×”', '×•', '×©'],
          longhand: ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'],
        },
        months: {
          shorthand: ['×™× ×•', '×¤×‘×¨', '××¨×¥', '××¤×¨', '×××™', '×™×•× ', '×™×•×œ', '××•×’', '×¡×¤×˜', '××•×§', '× ×•×‘', '×“×¦×'],
          longhand: ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'],
        },
      },
      onClose: function (selectedDates) {
        if (selectedDates.length === 2) {
          const [from, to] = selectedDates;
          document.getElementById('dateFrom').value = from.toLocaleDateString('sv-SE');
          document.getElementById('dateTo').value = to.toLocaleDateString('sv-SE');
        }
      },
      onReady: function (selectedDates, dateStr, instance) {
        fixFlatpickrHeaderOrder(instance);
      },
      onMonthChange: function (selectedDates, dateStr, instance) {
        fixFlatpickrHeaderOrder(instance);
      },
      onYearChange: function (selectedDates, dateStr, instance) {
        fixFlatpickrHeaderOrder(instance);
      }
    });

    function fixFlatpickrHeaderOrder(instance) {
      const container = instance.calendarContainer.querySelector(".flatpickr-months");
      const months = container.querySelectorAll(".flatpickr-month");
      if (months.length === 2) {
        container.insertBefore(months[1], months[0]);
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
      const searchInput = document.getElementById('searchInput');
      const clearSearch = document.getElementById('clearSearch');
      const loadingContainer = document.getElementById('loadingContainer');
      const compareButtonContainer = document.getElementById('compareButtonContainer');
      const compareButton = document.getElementById('compareButton');
      const resultsContainer = document.getElementById('resultsContainer');
      const sortContainer = document.getElementById('sortContainer');
      const sortSelect = document.getElementById('sortSelect');

      let currentSearchQuery = '';
      let allSites = [];
      let searchedUrl = '';
      let currentResults = [];

      // ××©×ª× ×™× ×œ×˜×™×¡×•×ª
      let citiesData = [];
      let flightResults = [];
      let filteredFlightResults = [];
      let selectedOrigin = null;
      let selectedDestination = null;
      let pollingInterval = null;

      const globeModal = document.getElementById('globeModal');
      const globeIcon = document.getElementById('globeIcon');
      const actionBtn = document.getElementById('globeActionBtn');
      const closeBtn = document.getElementById('closeGlobeModalBtn');
      const selectedCityText = document.getElementById('selectedCityText');
      const randomBtn = document.getElementById('randomDestinationBtn');
      const refreshBtn = document.getElementById('globeRefreshBtn');
      const finger = document.getElementById('globeFinger');

      let globeTimeout = null;
      let selectedCity = null;
      let isStopped = false;
      let cityAnimationInterval = null;

      function startSpinning() {
        selectedCity = null;
        isStopped = false;

        globeModal.classList.remove('hidden');
        globeIcon.classList.add('animate-spin-slow');
        actionBtn.textContent = '×¢×¦×•×¨';
        refreshBtn.classList.add('hidden');

        // ×”×¨×—×§ ××ª ×”××¦×‘×¢
        finger.classList.remove('translate-x-10');
        finger.classList.add('translate-x-20');

        // ×”×¤×¢×œ ×× ×™××¦×™×” ×©×œ ×©××•×ª ×¢×¨×™×
        cityAnimationInterval = setInterval(() => {
          if (!citiesData || citiesData.length === 0) return;
          const randomCity = citiesData[Math.floor(Math.random() * citiesData.length)];
          selectedCityText.textContent = `${randomCity.city_name_heb}, ${randomCity.country_name_heb}`;
        }, 100);

        globeTimeout = setTimeout(stopSpinningAndPickCity, 3000);
      }

      function stopSpinningAndPickCity() {
        isStopped = true;
        globeIcon.classList.remove('animate-spin-slow');

        // ×¢×¦×•×¨ ××ª ×”×× ×™××¦×™×” ×©×œ ×”×¢×¨×™×
        clearInterval(cityAnimationInterval);

        if (!citiesData || citiesData.length === 0) return;

        selectedCity = citiesData[Math.floor(Math.random() * citiesData.length)];
        selectedCityText.textContent = `${selectedCity.city_name_heb}, ${selectedCity.country_name_heb}`;

        // ×§×¨×‘ ××ª ×”××¦×‘×¢
        finger.classList.remove('translate-x-20');
        finger.classList.add('translate-x-10');

        actionBtn.textContent = '×‘×—×¨';
        refreshBtn.classList.remove('hidden');
      }

      randomBtn.addEventListener('click', startSpinning);

      actionBtn.addEventListener('click', () => {
        if (!isStopped) {
          clearTimeout(globeTimeout);
          stopSpinningAndPickCity();
        } else {
          // ×‘×™×¦×•×¢ ×”×‘×—×™×¨×” ×‘×¤×•×¢×œ
          if (selectedCity) {
            selectedDestination = {
              code: selectedCity.airport_iata,
              nameHeb: selectedCity.city_name_heb,
              nameEng: selectedCity.city_name_eng
            };
            document.getElementById('destinationInput').value = `${selectedCity.city_name_heb} (${selectedCity.airport_iata})`;
          }
          globeModal.classList.add('hidden');
        }
      });

      closeBtn.addEventListener('click', () => {
        clearTimeout(globeTimeout);
        clearInterval(cityAnimationInterval);
        globeModal.classList.add('hidden');
      });

      // ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ ×—×•×–×¨ â€” ×”×ª×—×œ×” ××—×“×©
      refreshBtn.addEventListener('click', () => {
        clearTimeout(globeTimeout);
        clearInterval(cityAnimationInterval);
        startSpinning();
      });


      // ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ cache
      function saveFlightSearchToCache(searchParams, cheapestFlight) {
        try {
          const cacheKey = 'flightSearchCache';
          let cache = JSON.parse(localStorage.getItem(cacheKey) || '[]');

          const searchData = {
            id: Date.now().toString(),
            searchTime: new Date().toISOString(),
            origin: searchParams.origin,
            destination: searchParams.destination,
            dateFrom: searchParams.dateFrom,
            dateTo: searchParams.dateTo,
            cheapestFlight: {
              price: cheapestFlight.price_usd,
              airline: cheapestFlight.airline_name,
              direct: cheapestFlight.direct,
              nights: cheapestFlight.nights,
              url: cheapestFlight.fly_url
            }
          };

          // ×”×¡×¨ ×—×™×¤×•×©×™× ×™×©× ×™× ×©×œ ××•×ª×• ××¡×œ×•×œ
          cache = cache.filter(item =>
            !(item.origin.code === searchParams.origin.code &&
              item.destination.code === searchParams.destination.code &&
              item.dateFrom === searchParams.dateFrom &&
              item.dateTo === searchParams.dateTo)
          );

          // ×”×•×¡×£ ×”×—×™×¤×•×© ×”×—×“×© ×‘×ª×—×™×œ×ª ×”××¢×¨×š
          cache.unshift(searchData);

          // ×©××•×¨ ×¨×§ 5 ×—×™×¤×•×©×™× ××—×¨×•× ×™×
          cache = cache.slice(0, 5);

          localStorage.setItem(cacheKey, JSON.stringify(cache));
        } catch (error) {
          console.error('Error saving to cache:', error);
        }
      }

      function getRecentSearchesFromCache() {
        try {
          const cacheKey = 'flightSearchCache';
          return JSON.parse(localStorage.getItem(cacheKey) || '[]');
        } catch (error) {
          console.error('Error reading from cache:', error);
          return [];
        }
      }

      function displayRecentSearches() {
        const recentSearches = getRecentSearchesFromCache();
        const container = document.getElementById('recentSearchesContainer');
        const list = document.getElementById('recentSearchesList');

        if (recentSearches.length === 0) {
          container.style.display = 'none';
          return;
        }

        container.style.display = 'block';
        list.innerHTML = '';

        recentSearches.forEach(search => {
          const searchItem = document.createElement('div');
          searchItem.className = 'recent-search-item';
          searchItem.onclick = () => {
            // ××œ× ××ª ×”×©×“×•×ª ×•×‘×¦×¢ ×—×™×¤×•×© ××—×“×©
            fillSearchFields(search);
          };

          const timeAgo = getTimeAgo(search.searchTime);
          const flight = search.cheapestFlight;

          searchItem.innerHTML = `
            <div class="recent-search-header">
              <div class="recent-search-route">
                ${search.origin.nameHeb} â†’ ${search.destination.nameHeb}
              </div>
              <div class="recent-search-price">$${flight.price}</div>
            </div>
            <div class="recent-search-details">
              <div class="recent-search-dates">
                ${formatDateForDisplay(search.dateFrom)} - ${formatDateForDisplay(search.dateTo)} â€¢ ${flight.nights} ×œ×™×œ×•×ª
                ${flight.direct ? '<span class="recent-search-badge">×™×©×™×¨×”</span>' : '<span class="recent-search-badge" style="background: #ffc107; color: #333;">×¢×¦×™×¨×”</span>'}
                <span style="color: #666; font-size: 12px;">${flight.airline}</span>
              </div>
              <div class="recent-search-time">${timeAgo}</div>
            </div>
          `;

          list.appendChild(searchItem);
        });
      }

      function fillSearchFields(search) {
        // ×”×’×“×¨ ××ª ×”×¢×¨×™× ×”× ×‘×—×¨×•×ª
        selectedOrigin = search.origin;
        selectedDestination = search.destination;

        // ××œ× ××ª ×”×©×“×•×ª
        document.getElementById('originInput').value = `${search.origin.nameHeb} (${search.origin.code})`;
        document.getElementById('destinationInput').value = `${search.destination.nameHeb} (${search.destination.code})`;

        // ×”×’×“×¨ ×ª××¨×™×›×™×
        document.getElementById('dateFrom').value = search.dateFrom;
        document.getElementById('dateTo').value = search.dateTo;

        // ×¢×“×›×Ÿ ×œ×•×— ×”×©× ×”
        const dateRangeInput = document.getElementById('dateRange');
        dateRangeInput.value = `${search.dateFrom} ×¢×“ ${search.dateTo}`;
        if (dateRangeInput._flatpickr) {
          dateRangeInput._flatpickr.setDate([search.dateFrom, search.dateTo]);
        }

        // ×¢×“×›×Ÿ URL ×•×‘×¦×¢ ×—×™×¤×•×©
        updateUrlWithFlightParams(selectedOrigin, selectedDestination, search.dateFrom, search.dateTo);
        fetchFlights(selectedOrigin.code, selectedDestination.code, search.dateFrom, search.dateTo);
      }

      function getTimeAgo(dateString) {
        const now = new Date();
        const past = new Date(dateString);
        const diffInMinutes = Math.floor((now - past) / (1000 * 60));

        if (diffInMinutes < 1) return '×¢×›×©×™×•';
        if (diffInMinutes < 60) return `×œ×¤× ×™ ${diffInMinutes} ×“×§×•×ª`;

        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `×œ×¤× ×™ ${diffInHours} ×©×¢×•×ª`;

        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays === 1) return '××ª××•×œ';
        if (diffInDays < 7) return `×œ×¤× ×™ ${diffInDays} ×™××™×`;

        return `×œ×¤× ×™ ${Math.floor(diffInDays / 7)} ×©×‘×•×¢×•×ª`;
      }

      function formatDateForDisplay(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('he-IL', {
          day: '2-digit',
          month: '2-digit'
        });
      }
      function initializePageFromUrl() {
        if (hasFlightParams()) {
          // ×¢×‘×•×¨ ×œ×˜××‘ ×”×˜×™×¡×•×ª
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelector('[data-tab="flights"]').classList.add('active');

          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          document.getElementById('flights-tab').classList.add('active');

          loadCitiesData().then(() => {
            loadFlightParamsFromUrl();
          });
        }
      }

      function loadFlightParamsFromUrl() {
        const params = getFlightParamsFromUrl();

        if (params.origin && params.destination && params.dateFrom && params.dateTo) {
          selectedOrigin = {
            code: params.origin,
            nameHeb: params.originName || params.origin,
            nameEng: params.origin
          };
          selectedDestination = {
            code: params.destination,
            nameHeb: params.destinationName || params.destination,
            nameEng: params.destination
          };

          document.getElementById('originInput').value = `${selectedOrigin.nameHeb} (${selectedOrigin.code})`;
          document.getElementById('destinationInput').value = `${selectedDestination.nameHeb} (${selectedDestination.code})`;

          document.getElementById('dateFrom').value = params.dateFrom;
          document.getElementById('dateTo').value = params.dateTo;

          const dateRangeInput = document.getElementById('dateRange');
          dateRangeInput.value = `${params.dateFrom} ×¢×“ ${params.dateTo}`;
          dateRangeInput._flatpickr.setDate([params.dateFrom, params.dateTo]);

          fetchFlights(selectedOrigin.code, selectedDestination.code, params.dateFrom, params.dateTo);
        }
      }

      // ×œ×•×’×™×§×ª ×˜××‘×™×
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          const tabName = button.dataset.tab;

          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');

          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          document.getElementById(`${tabName}-tab`).classList.add('active');

          if (tabName === 'flights' && citiesData.length === 0) {
            loadCitiesData().then(() => {
              // ×”×¦×’ ×—×™×¤×•×©×™× ××—×¨×•× ×™× ×›×©×¢×•×‘×¨×™× ×œ×˜××‘ ×˜×™×¡×•×ª
              displayRecentSearches();
            });
          } else if (tabName === 'flights') {
            // ×× ×”× ×ª×•× ×™× ×›×‘×¨ × ×˜×¢× ×•, ×¤×©×•×˜ ×”×¦×’ ×—×™×¤×•×©×™× ××—×¨×•× ×™×
            displayRecentSearches();
          }
        });
      });

      // ×¤×•× ×§×¦×™×•×ª ×˜×™×¡×•×ª
      async function loadCitiesData() {
        try {
          const response = await fetch('https://tiv7rvgnp4.execute-api.il-central-1.amazonaws.com/cityToIATA?city=all_results');
          citiesData = await response.json();
          console.log('Cities data loaded:', citiesData.length);
        } catch (error) {
          console.error('Error loading cities:', error);
        }
      }

      function normalize(str) {
        return str.toLowerCase().replace(/[^a-zA-Z\u0590-\u05FF0-9]/g, '');
      }

      function searchCities(query) {
        if (!query || query.length < 2) return [];

        const normalizedQuery = normalize(query);

        return citiesData.filter(city => {
          const cityHeb = normalize(city.city_name_heb || '');
          const cityEng = normalize(city.city_name_eng || '');
          const countryHeb = normalize(city.country_name_heb || '');
          const countryEng = normalize(city.country_name_eng || '');
          const iata = (city.airport_iata || '').toLowerCase();
          const synonyms = Array.isArray(city.city_synonyms) ? city.city_synonyms.map(normalize) : [];

          return (
            cityHeb.includes(normalizedQuery) ||
            cityEng.includes(normalizedQuery) ||
            countryHeb.includes(normalizedQuery) ||
            countryEng.includes(normalizedQuery) ||
            iata.includes(normalizedQuery) ||
            synonyms.some(s => s.includes(normalizedQuery))
          );
        }).slice(0, 10);
      }

      function showSuggestions(inputId, suggestions) {
        const suggestionsDiv = document.getElementById(`${inputId}Suggestions`);
        if (!suggestionsDiv) return;

        if (suggestions.length === 0) {
          suggestionsDiv.classList.remove('show');
          return;
        }

        suggestionsDiv.innerHTML = suggestions.map(city => `
    <div class="suggestion-item" data-iata="${city.airport_iata}" data-city-name-heb="${city.city_name_heb}" data-city-name-eng="${city.city_name_eng}">
      <strong>${city.city_name_heb}</strong> (${city.airport_iata})
      <small>${city.airport_name}, ${city.country_name_heb}</small>
    </div>
  `).join('');

        suggestionsDiv.classList.add('show');

        suggestionsDiv.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', () => {
            const iata = item.dataset.iata;
            const cityNameHeb = item.dataset.cityNameHeb;
            const cityNameEng = item.dataset.cityNameEng;
            const input = document.getElementById(`${inputId}Input`);

            input.value = `${cityNameHeb} (${iata})`;
            suggestionsDiv.classList.remove('show');

            if (inputId === 'origin') {
              selectedOrigin = { code: iata, nameHeb: cityNameHeb, nameEng: cityNameEng };
            } else {
              selectedDestination = { code: iata, nameHeb: cityNameHeb, nameEng: cityNameEng };
            }
          });
        });
      }

      ['origin', 'destination'].forEach(id => {
        const input = document.getElementById(`${id}Input`);
        const suggestionsDiv = document.getElementById(`${id}Suggestions`);

        if (!input || !suggestionsDiv) return;

        input.addEventListener('input', (e) => {
          const query = e.target.value;
          const suggestions = searchCities(query);
          showSuggestions(id, suggestions);
        });

        input.addEventListener('blur', () => {
          setTimeout(() => {
            suggestionsDiv.classList.remove('show');
          }, 200);
        });

        input.addEventListener('focus', () => {
          if (input.value) {
            const suggestions = searchCities(input.value);
            showSuggestions(id, suggestions);
          }
        });
      });

      // ×—×™×¤×•×© ×˜×™×¡×•×ª
      document.getElementById('searchFlightsBtn').addEventListener('click', () => {
        if (!selectedOrigin || !selectedDestination) {
          alert('×× × ×‘×—×¨ ××•×¦× ×•×™×¢×“');
          return;
        }

        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        if (!dateFrom || !dateTo) {
          alert('×× × ×‘×—×¨ ×ª××¨×™×›×™ ×™×¦×™××” ×•×—×–×¨×”');
          return;
        }

        if (new Date(dateFrom) >= new Date(dateTo)) {
          alert('×ª××¨×™×š ×”×—×–×¨×” ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×ª××¨×™×š ×”×™×¦×™××”');
          return;
        }

        updateUrlWithFlightParams(selectedOrigin, selectedDestination, dateFrom, dateTo);
        fetchFlights(selectedOrigin.code, selectedDestination.code, dateFrom, dateTo);
      });

      async function fetchFlights(originCode, destinationCode, dateFrom, dateTo) {
        try {
          const todayDateStr = new Date().toISOString().split('T')[0];

          if (dateFrom === todayDateStr) {
            document.getElementById('flightResultsContainer').innerHTML = `
    <div style="padding: 40px 20px; text-align: center; color: #e74c3c;">
      <div style="font-size: 60px; margin-bottom: 20px;">ğŸ›‘</div>
      <h3 style="margin-bottom: 15px; font-size: 18px;">×œ× × ×™×ª×Ÿ ×œ×—×¤×© ×˜×™×¡×•×ª ×©×™×•×¦××•×ª ×”×™×•×</h3>
      <p>×× × ×‘×—×¨ ×ª××¨×™×š ×™×¦×™××” ×¢×ª×™×“×™.</p>
    </div>
  `;
            return;
          }

          // ×”×¦×’ ×—×™×¤×•×©×™× ××—×¨×•× ×™× ×œ×¤× ×™ ×ª×—×™×œ×ª ×”×—×™×¤×•×© ×”×—×“×©
          displayRecentSearches();

          const url = `https://2gxkd3dzwd.execute-api.il-central-1.amazonaws.com/stag1/api/flights?origin=${originCode}&destination=${destinationCode}&date_from=${dateFrom}&date_to=${dateTo}`;

          document.getElementById('flightResultsContainer').innerHTML = '';
          document.getElementById('flightLoadingContainer').style.display = 'block';
          document.getElementById('filtersContainer').style.display = 'none';

          await performFlightsRequest(url);

        } catch (error) {
          console.error('Error fetching flights:', error);
          displayError(error.message);
        }
      }

      async function performFlightsRequest(url, retryCount = 0) {
        try {
          const response = await fetch(url);
          const statusCode = response.status;

          if (statusCode >= 500 && statusCode < 600) {
            console.warn(`Server error ${statusCode}, attempt ${retryCount + 1}`);

            if (retryCount < 4) {
              console.log(`Retrying in 3 seconds... (attempt ${retryCount + 2}/3)`);
              setTimeout(() => {
                performFlightsRequest(url, retryCount + 1);
              }, 3000);
              return;
            } else {
              throw new Error(`Server error ${statusCode} - failed after 3 attempts`);
            }
          }

          const rawResults = await response.json();

          if (!Array.isArray(rawResults)) {
            console.error('Invalid response format - not an array:', rawResults);

            if (retryCount < 4) {
              console.log(`Invalid response format, retrying in 3 seconds... (attempt ${retryCount + 2}/3)`);
              setTimeout(() => {
                performFlightsRequest(url, retryCount + 1);
              }, 3000);
              return;
            } else {
              throw new Error('Invalid response format after 3 attempts');
            }
          }

          if (statusCode === 206) {
            startPolling(url);
          } else {
            stopPolling();
          }

          processFlightResults(rawResults, statusCode);
        } catch (error) {
          console.error('Error in flight request:', error);

          if (retryCount < 2 && (error.name === 'TypeError' || error.message.includes('fetch'))) {
            console.log(`Network error, retrying in 3 seconds... (attempt ${retryCount + 2}/3)`);
            setTimeout(() => {
              performFlightsRequest(url, retryCount + 1);
            }, 3000);
            return;
          }

          displayError(error.message);
          stopPolling();
        }
      }

      function startPolling(url) {
        if (pollingInterval) return;

        updateFlightSearchStatus('××¦×× ×• ×ª×•×¦××•×ª ×¨××©×•× ×™×•×ª â€” ×××©×™×›×™× ×œ×—×¤×© ×‘××§×•××•×ª × ×•×¡×¤×™× ×›×“×™ ×œ××¦×•× ××—×™×¨ ××¤×™×œ×• ×–×•×œ ×™×•×ª×¨...');

        pollingInterval = setInterval(async () => {
          try {
            const response = await fetch(url);
            const results = await response.json();

            if (response.status === 200) {
              stopPolling();
              processFlightResults(results, 200);
            } else if (response.status === 206) {
              processFlightResults(results, 206);
            }
          } catch (error) {
            console.error('Polling error:', error);
          }
        }, 5000);
      }

      function stopPolling() {
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
        document.getElementById('loadingStatus').textContent = '';
        updateFlightSearchStatus('×”×—×™×¤×•×© ×”×•×©×œ× âœ…');
      }

      function updateFlightSearchStatus(message, show = true) {
        const statusDiv = document.getElementById('flightSearchStatus');
        if (statusDiv) {
          statusDiv.textContent = message;
          statusDiv.style.display = show ? 'block' : 'none';
        }
      }

      function processFlightResults(results, statusCode) {
        document.getElementById('flightLoadingContainer').style.display = 'none';

        if (results.length === 0) {
          document.getElementById('flightResultsContainer').innerHTML = '<p class="text-center text-gray-600">×œ× × ××¦××• ×˜×™×¡×•×ª ×”×ª×•×××•×ª ×œ×—×™×¤×•×© ×©×œ×š</p>';
          return;
        }

        flightResults = results;
        filteredFlightResults = [...results];

        // ×©××•×¨ ××ª ×”×˜×™×¡×” ×”×–×•×œ×” ×‘×™×•×ª×¨ ×œ×§××© (×¨×§ ×‘×¡×™×•× ×”×—×™×¤×•×©)
        if (statusCode === 200) {
          const cheapestFlight = results.reduce((prev, current) =>
            prev.price_usd < current.price_usd ? prev : current
          );

          const searchParams = {
            origin: selectedOrigin,
            destination: selectedDestination,
            dateFrom: document.getElementById('dateFrom').value,
            dateTo: document.getElementById('dateTo').value
          };

          saveFlightSearchToCache(searchParams, cheapestFlight);

          // ×¢×“×›×Ÿ ×”×¦×’×ª ×”×—×™×¤×•×©×™× ×”××—×¨×•× ×™×
          displayRecentSearches();
        }

        updateAirlineFilter(results);

        document.getElementById('filtersContainer').style.display = 'flex';
        displayFlightResults(filteredFlightResults);

        if (statusCode === 206) {
          document.getElementById('loadingStatus').textContent = '×××©×™×š ×œ×—×¤×© ×¢×•×“ ×˜×™×¡×•×ª...';
        }
      }

      function updateAirlineFilter(results) {
        const airlines = new Set();
        results.forEach(flight => {
          if (flight.airline_name) {
            airlines.add(flight.airline_name);
          }
        });

        const airlineFilter = document.getElementById('airlineFilter');
        airlineFilter.innerHTML = '<option value="">×›×œ ×”×—×‘×¨×•×ª</option>';

        Array.from(airlines).sort().forEach(airline => {
          const option = document.createElement('option');
          option.value = airline;
          option.textContent = airline;
          airlineFilter.appendChild(option);
        });
      }

      function displayFlightResults(results) {
        const container = document.getElementById('flightResultsContainer');

        if (results.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-600">××™×Ÿ ×˜×™×¡×•×ª ×”×ª×•×××•×ª ×œ×¡×™× ×•×Ÿ ×©× ×‘×—×¨</p>';
          return;
        }

        container.innerHTML = results.map((flight, index) => {
          const isDirect = flight.direct;
          const outboundDetails = flight.deal_details.outbound;
          const inboundDetails = flight.deal_details.inbound;

          return `
          <div class="flight-card with-bg" style="background-image: url('${flight.image_url}')">
              <div class="flight-header">
                <div class="flight-airline">
                  <span class="airline-name">${flight.airline_name}</span>
                  ${isDirect ? '<span class="direct-badge">×™×©×™×¨×”</span>' : '<span class="connecting-badge">×¢× ×¢×¦×™×¨×”</span>'}
                </div>
                <div class="flight-price">${flight.price_usd} $</div>
              </div>
              
              <div class="flight-body">
                <div class="flight-route">
                  <div class="flight-endpoint">
                    <div class="flight-time">${formatTime(outboundDetails[0].departure_time)}</div>
                    <div class="flight-location">${flight.origin_city}</div>
                  </div>
                  
                  <div class="flight-arrow">â†’</div>
                  
                  <div class="flight-endpoint">
                    <div class="flight-time">${formatTime(outboundDetails[outboundDetails.length - 1].arrival_time)}</div>
                    <div class="flight-location">${flight.destination_city}</div>
                  </div>
                </div>
                
                <div class="flight-dates">
                  ${flight.dates_subtitle} â€¢ ${flight.nights} ×œ×™×œ×•×ª
                </div>
                
                <div class="flight-actions">
                  <button class="flight-book-btn" onclick="bookFlight('${flight.fly_url}')">
                    ×”×–××Ÿ ×˜×™×¡×”
                  </button>
                  <button class="flight-details-toggle" onclick="toggleFlightDetails(${index})">
                    ×¤×¨×˜×™ ×˜×™×¡×”
                  </button>
                </div>
              </div>
              
              <div id="flight-details-${index}" class="flight-details">
                <div class="flight-segment">
                  <div class="segment-title">×˜×™×¡×ª ×”×œ×•×š - ${formatDate(flight.date_from)}</div>
                  ${renderFlightLegs(outboundDetails, flight.deal_details)}
                </div>
                
                <div class="flight-segment">
                  <div class="segment-title">×˜×™×¡×ª ×—×–×•×¨ - ${formatDate(flight.date_to)}</div>
                  ${renderFlightLegs(inboundDetails, flight.deal_details, true)}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      function renderFlightLegs(legs, details, isInbound = false) {
        return legs.map((leg, index) => {
          let html = '';

          if (index > 0) {
            const connectionTime = leg.connection_length;
            const connectionCity = isInbound ? details.connection_city_inbound : details.connection_city_outbound;
            const connectionCountry = isInbound ? details.connection_country_inbound : details.connection_country_outbound;

            if (connectionTime) {
              html += `
                <div class="connection-info">
                  ×¢×¦×™×¨×” ×©×œ ${formatDuration(connectionTime)} ×‘${connectionCity}, ${connectionCountry}
                </div>
              `;
            }
          }

          html += `
            <div class="flight-leg">
              <div>
                <div class="font-semibold">${formatTime(leg.departure_time)}</div>
                <div class="text-sm text-gray-600">×™×¦×™××”</div>
              </div>
              <div class="text-center">
                <div class="text-sm text-gray-600">××©×š ×˜×™×¡×”</div>
                <div>${formatDuration(leg.flight_duration)}</div>
              </div>
              <div class="text-left">
                <div class="font-semibold">${formatTime(leg.arrival_time)}</div>
                <div class="text-sm text-gray-600">× ×—×™×ª×”</div>
              </div>
            </div>
          `;

          return html;
        }).join('');
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('he-IL');
      }

      function formatDuration(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${h} ×©×¢×•×ª ${m > 0 ? `${m} ×“×§×•×ª` : ''}`;
      }

      window.toggleFlightDetails = function (index) {
        const details = document.getElementById(`flight-details-${index}`);
        details.classList.toggle('show');
      };

      window.bookFlight = function (url) {
        window.open(url, '_blank');

        // FlightBooking  ->  GA4: flight_booking
        if (typeof gtag === 'function') {
          gtag('event', 'flight_booking', {
            url: url
          });
        }

      };

      function displayError(message) {
        document.getElementById('flightLoadingContainer').style.display = 'none';
        document.getElementById('flightResultsContainer').innerHTML = `
          <div class="text-center text-red-600 p-4">
            <p>××™×¨×¢×” ×©×’×™××”: ${message}</p>
          </div>
        `;
        updateFlightSearchStatus('×”×—×™×¤×•×© ×”×¡×ª×™×™× â€“ ×œ× × ××¦××• ×˜×™×¡×•×ª × ×•×¡×¤×•×ª ××• ×©×’×™××” ×”×ª×¨×—×©×”.', true);
      }

      // ×¤×™×œ×˜×¨×™× ×•××™×•×Ÿ
      document.getElementById('directFlightsOnly').addEventListener('change', applyFilters);
      document.getElementById('maxPriceFilter').addEventListener('input', applyFilters);
      document.getElementById('airlineFilter').addEventListener('change', applyFilters);
      document.getElementById('sortFlights').addEventListener('change', applySorting);

      function applyFilters() {
        const directOnly = document.getElementById('directFlightsOnly').checked;
        const maxPrice = parseFloat(document.getElementById('maxPriceFilter').value) || Infinity;
        const selectedAirline = document.getElementById('airlineFilter').value;

        filteredFlightResults = flightResults.filter(flight => {
          if (directOnly && !flight.direct) return false;
          if (flight.price_usd > maxPrice) return false;
          if (selectedAirline && flight.airline_name !== selectedAirline) return false;
          return true;
        });

        applySorting();
      }

      function applySorting() {
        const sortBy = document.getElementById('sortFlights').value;

        filteredFlightResults.sort((a, b) => {
          switch (sortBy) {
            case 'price-asc':
              return a.price_usd - b.price_usd;
            case 'price-desc':
              return b.price_usd - a.price_usd;
            case 'duration-asc':
              const durationA = a.deal_details.outbound_duration + a.deal_details.inbound_duration;
              const durationB = b.deal_details.outbound_duration + b.deal_details.inbound_duration;
              return durationA - durationB;
            case 'nights':
              return a.nights - b.nights;
            default:
              return 0;
          }
        });

        displayFlightResults(filteredFlightResults);
      }

      // ×¤×•× ×§×¦×™×•×ª ××•×¦×¨×™×
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      function checkAndLogSource() {
        const source = getUrlParameter('source');
        if (source && typeof plausible === 'function') {
          plausible('TrafficSource', { props: { source: source } });
        }
      }

      function updateUrlWithSearchQuery(query) {
        if (history.pushState) {
          var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?query=' + encodeURIComponent(query);
          window.history.pushState({ path: newurl }, '', newurl);
        }
      }

      function animateTyping(text, callback, index = 0) {
        if (index < text.length) {
          searchInput.value += text[index];
          setTimeout(() => animateTyping(text, callback, index + 1), 100);
        } else {
          search(text);
          if (callback) callback();
        }
      }

      function showLoading() {
        loadingContainer.style.display = 'block';
      }

      function hideLoading() {
        loadingContainer.style.display = 'none';
      }

      function updateCompareButton(query) {
        if (query.trim()) {
          compareButton.textContent = `×”×©×•×•××ª ××—×™×¨×™× ×¢×‘×•×¨ "${query}"`;
          compareButtonContainer.style.display = 'block';
        } else {
          compareButtonContainer.style.display = 'none';
        }
      }

      function search(query) {
        currentSearchQuery = query;
        showLoading();
        resultsContainer.innerHTML = '';
        updateUrlWithSearchQuery(query);

        if (query.trim() === '') {
          hideLoading();
          displayPopularSearches();
          sortContainer.style.display = 'none';
          return;
        }

        sortContainer.style.display = 'none';

        if (query.toLowerCase().startsWith('https://')) {
          searchedUrl = query;
          searchByUrl(query);
        } else {
          searchedUrl = '';
          const filteredSites = allSites.filter(site =>
            site.siteName.toLowerCase().includes(query.toLowerCase()) ||
            (site.cuponDetails && site.cuponDetails.toLowerCase().includes(query.toLowerCase()))
          );

          hideLoading();
          displaySearchResults(filteredSites);
          updateCompareButton(query);

          const estimatedPriceContainer = document.getElementById('estimatedPriceContainer');
          if (filteredSites.length === 0) {
            estimatedPriceContainer.style.display = 'block';
          } else {
            estimatedPriceContainer.style.display = 'none';
          }
        }

        gtag('event', 'Search', {
          query: query
        });

      }

      function searchByUrl(url) {
        const matchingSite = allSites.find(site => url.toLowerCase().startsWith(site.URL.toLowerCase()));

        if (matchingSite) {
          displaySearchResults([matchingSite], true);
          updateCompareButton(matchingSite.siteName);
        } else {
          displayNoCouponMessage(url);
        }

        hideLoading();
      }

      function displayNoCouponMessage(url) {
        const siteName = new URL(url).hostname;
        resultsContainer.innerHTML = `
          <p>× ×¨××” ×©××™×Ÿ ×›××Ÿ ×§×•×¤×•×Ÿ, ××¤×©×¨ ×œ×œ×—×•×¥ ×›××Ÿ ×•×œ×‘×§×© ×œ×”×•×¡×™×£</p>
          <button class="request-coupon-button" onclick="requestCoupon('${siteName}')">×‘×§×©×ª ×”×˜×‘×” ×œ${siteName}</button>
        `;
      }

      function requestCoupon(siteName) {
        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.placeholder = '×”×–×Ÿ ××ª ×›×ª×•×‘×ª ×”××™×™×œ ×©×œ×š';
        emailInput.className = 'email-input';

        const submitButton = document.createElement('button');
        submitButton.textContent = '×©×œ×™×—×”';
        submitButton.className = 'request-coupon-button';
        submitButton.onclick = function () {
          const email = emailInput.value;
          if (email) {
            if (typeof gtag === 'function') {
              gtag('event', 'coupon_request', {
                site: siteName,
                email_domain: (email || '').split('@')[1] || ''
              });
            }

            alert('×”×‘×§×©×” × ×©×œ×—×”');
            emailInput.remove();
            submitButton.remove();
          } else {
            alert('×× × ×”×–×Ÿ ×›×ª×•×‘×ª ××™×™×œ ×ª×§×™× ×”');
          }
        };

        resultsContainer.appendChild(emailInput);
        resultsContainer.appendChild(submitButton);
      }

      function displayPopularSearches() {
        const popularSearches = [
          "Ali express", "Golf", "×”××©×‘×™×¨", "ACE",
          "××™×™×¨×¤×•×“×¡", "NAUTICA", "×‘×•×©× ×œ×’×‘×¨", "Toys R us"
        ];

        const container = document.createElement('div');
        container.className = 'popular-searches-container';

        const title = document.createElement('h3');
        title.textContent = '×—×™×¤×•×©×™× × ×¤×•×¦×™×';
        container.appendChild(title);

        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'popular-search-buttons';

        popularSearches.forEach(searchQuery => {
          const button = document.createElement('button');
          button.textContent = searchQuery;
          button.className = 'popular-search-button';
          button.addEventListener('click', () => {
            searchInput.value = searchQuery;
            // PopularSearch  ->  GA4: popular_search
            if (typeof gtag === 'function') {
              gtag('event', 'popular_search', {
                query: searchQuery
              });
            }

            handleSearchInput();
          });
          buttonContainer.appendChild(button);
        });

        container.appendChild(buttonContainer);
        resultsContainer.appendChild(container);
      }

      function displaySearchResults(results, isUrlSearch = false) {
        resultsContainer.innerHTML = '';
        const uniqueResults = new Map();

        results.forEach(site => {
          if (!uniqueResults.has(site.siteName)) {
            uniqueResults.set(site.siteName, site);
          }
        });

        uniqueResults.forEach(site => {
          const siteDiv = document.createElement('div');
          siteDiv.className = 'product';

          let siteContent = `<h3>${site.siteName}</h3>`;

          if (site.cupon && site.cupon !== "") {
            siteContent += `
              <div class="coupon-details">
                <button class="coupon-toggle">×¤×¨×˜×™ ×§×•×¤×•×Ÿ</button>
                <div class="coupon-content">
                  <span>${site.cupon}</span>
                  <span class="copy-icon" onclick="copyCoupon('${site.cupon}', event)">ğŸ“‹</span>
                  <a href="#" class="site-link" onclick="goToSite('${site.affLink || site.URL}', '${site.siteName}', '${isUrlSearch ? '×œ××•×¦×¨' : '×œ××ª×¨'}', event)">
                    ×¢×‘×•×¨ ${isUrlSearch ? '×œ××•×¦×¨' : '×œ××ª×¨'}
                  </a>
                  <p class="coupon-info">${site.cuponDetails || ''}</p>
                </div>
              </div>
            `;
          } else {
            siteContent += `<a href="#" class="site-link" onclick="goToSite('${site.affLink || site.URL}', '${site.siteName}', '${isUrlSearch ? '×œ××•×¦×¨' : '×œ××ª×¨'}', event)">
              ×¢×‘×•×¨ ${isUrlSearch ? '×œ××•×¦×¨' : '×œ××ª×¨'}
            </a>`;
          }

          siteDiv.innerHTML = siteContent;

          siteDiv.querySelector('h3').addEventListener('click', (event) => {
            goToSite(site.affLink || site.URL, site.siteName, isUrlSearch ? '×œ××•×¦×¨' : '×œ××ª×¨', event);
          });

          siteDiv.querySelector('.coupon-toggle')?.addEventListener('click', toggleCoupon);
          resultsContainer.appendChild(siteDiv);
        });

        const socialLinksContainer = document.getElementById('socialLinksContainer');
        if (uniqueResults.size > 0) {
          socialLinksContainer.style.display = 'block';
        } else {
          socialLinksContainer.style.display = 'none';
        }
      }

      function toggleCoupon(event) {
        const toggle = event.target;
        const content = toggle.nextElementSibling;
        toggle.classList.toggle('active');
        content.classList.toggle('active');
        event.stopPropagation();
      }

      function copyCoupon(coupon, event) {
        navigator.clipboard.writeText(coupon)
          .then(() => alert('×”×§×•×¤×•×Ÿ ×”×•×¢×ª×§'))
          .catch(err => console.error('Failed to copy: ', err));
        event.stopPropagation();

        gtag('event', 'coupon_copy', {
          coupon: coupon
        });

      }

      function performPriceComparison(query) {
        showLoading();
        sortContainer.style.display = 'none';

        let urlString = `https://kufu51g8uk.execute-api.il-central-1.amazonaws.com/stag/search?query=${encodeURIComponent(query)}&items=20&wideSearch=true`;

        const estimatedPrice = document.getElementById('estimatedPrice').value;
        if (estimatedPrice) {
          const minPrice = Math.floor(estimatedPrice * 0.5);
          const maxPrice = Math.floor(estimatedPrice * 1.5);
          urlString += `&minPrice=${minPrice}&maxPrice=${maxPrice}`;
        }

        fetch(urlString)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data.length === 0) {
              resultsContainer.innerHTML = '<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×”×©×•×•××ª ××—×™×¨×™×</p>';
            } else {
              currentResults = data;
              displayComparisonResults(data);
              sortContainer.style.display = 'block';
            }

            gtag('event', 'price_comparison', {
              query: query,
              estimated_price: estimatedPrice || 'none'
            });

          })
          .catch(error => {
            console.error('Error:', error);
            hideLoading();
            resultsContainer.innerHTML = '<p>××™×¨×¢×” ×©×’×™××” ×‘×”×©×•×•××ª ×”××—×™×¨×™×</p>';
          });
      }

      function displayComparisonResults(results) {
        // ×‘×“×™×§×” ×©×”× ×ª×•× ×™× × ×˜×¢× ×• ×œ×¤× ×™ ×¢×™×‘×•×“ ×”×ª×•×¦××•×ª
        if (!allSites || !Array.isArray(allSites)) {
          console.warn('allSites not loaded yet, skipping site info lookup');
        }

        resultsContainer.innerHTML = '<div class="comparison-result"></div>';
        const comparisonContainer = resultsContainer.querySelector('.comparison-result');

        results.forEach(product => {
          const productDiv = document.createElement('div');
          productDiv.className = 'comparison-item';

          // ×§×¨× ×œ×¤×•× ×§×¦×™×” ×¨×§ ×× ×”× ×ª×•× ×™× × ×˜×¢× ×•
          const siteInfo = (allSites && Array.isArray(allSites)) ? findSiteInfo(product.url) : null;

          const imageTag = product.image
            ? `<img src="${product.image}"
            alt="${product.name}"
            class="w-full h-40 object-contain mb-3 rounded">`
            : '';

          let productContent = `
      ${imageTag}
      <h3 onclick="goToProduct('${product.urlAff}', '${product.site}', '${product.name}')">
        ${product.name}
      </h3>
      <p>××—×™×¨: ${product.price}</p>
      <p>××ª×¨: ${product.site}</p>
    `;

          // ×‘×“×™×§×” ×× siteInfo ×§×™×™× ×•×× ×™×© ×§×•×¤×•×Ÿ
          if (siteInfo && siteInfo.cupon && siteInfo.cupon !== "") {
            productContent += `
        <div class="coupon-details">
          <button class="coupon-toggle">×¤×¨×˜×™ ×§×•×¤×•×Ÿ</button>
          <div class="coupon-content">
            <span>${siteInfo.cupon}</span>
            <span class="copy-icon" onclick="copyCoupon('${siteInfo.cupon}', event)">ğŸ“‹</span>
            <a href="${product.urlAff}" class="site-link" target="_blank">×¢×‘×•×¨ ×œ××ª×¨</a>
            <p class="coupon-info">${siteInfo.cuponDetails || ''}</p>
          </div>
        </div>
      `;
          } else {
            productContent += `<a href="${product.urlAff}" class="site-link" target="_blank">×¢×‘×•×¨ ×œ××ª×¨</a>`;
          }

          productDiv.innerHTML = productContent;
          productDiv.querySelector('.coupon-toggle')?.addEventListener('click', toggleCoupon);
          comparisonContainer.appendChild(productDiv);
        });

        const socialLinksContainer = document.getElementById('socialLinksContainer');
        if (results.length > 0) {
          socialLinksContainer.style.display = 'block';
        } else {
          socialLinksContainer.style.display = 'none';
        }
      }

      function goToProduct(url, siteName, productName) {
        window.open(url, '_blank');

        // ProductClick  ->  GA4: product_click
        if (typeof gtag === 'function') {
          gtag('event', 'product_click', {
            site: siteName,
            product: productName,
            query: currentSearchQuery
          });
        }

      }

      function goToSite(url, siteName, linkType, event) {
        if (event) event.preventDefault();

        let finalUrl = url;

        const siteInfo = allSites.find(site => site.siteName === siteName);

        if (siteInfo) {
          if (searchedUrl && linkType === '×œ××•×¦×¨') {
            if (url.startsWith('https://track')) {
              finalUrl = `${url}?forceURL=${encodeURIComponent(searchedUrl)}`;
            } else {
              finalUrl = searchedUrl;
            }
          } else if (siteInfo.affParam) {
            const urlObj = new URL(finalUrl);
            const separator = urlObj.search ? '&' : '?';

            if (siteInfo.affParam.startsWith('/')) {
              urlObj.pathname = siteInfo.affParam;
              urlObj.search = '';
            } else {
              finalUrl = `${finalUrl}${separator}${siteInfo.affParam}`;
            }
          }
        }

        window.open(finalUrl, '_blank');

        gtag('event', 'site_click', {
          site: siteName,
          link_type: linkType,
          original_url: url,
          final_url: finalUrl
        });

      }


      function findSiteInfo(url) {
        try {
          // ×‘×“×™×§×•×ª ×‘×¡×™×¡×™×•×ª
          if (!url || typeof url !== 'string' || url.trim() === '') {
            console.warn('Invalid or empty URL provided to findSiteInfo:', url);
            return null;
          }

          // ×‘×“×™×§×” ×× allSites ×§×™×™× ×•×××•×ª×—×œ
          if (!allSites || !Array.isArray(allSites) || allSites.length === 0) {
            console.warn('allSites is not initialized or empty');
            return null;
          }

          // × ×™×¡×™×•×Ÿ ×œ×™×¦×•×¨ ××•×‘×™×™×§×˜ URL
          const parsedUrl = new URL(url.trim());

          return allSites.find(site => {
            try {
              // ×‘×“×™×§×•×ª ×‘×˜×™×—×•×ª ×œ××ª×¨
              if (!site || !site.URL || typeof site.URL !== 'string' || site.URL.trim() === '') {
                return false;
              }

              // × ×™×¡×™×•×Ÿ ×œ×™×¦×•×¨ URL ×œ××ª×¨
              const siteUrl = new URL(site.URL.trim());
              return siteUrl.hostname === parsedUrl.hostname;
            } catch (siteError) {
              console.warn('Invalid site URL:', site?.URL, siteError.message);
              return false;
            }
          });
        } catch (error) {
          console.error('Error parsing URL in findSiteInfo:', url, error.message);

          // × ×¡×™×•×Ÿ ×—×œ×•×¤×™ ×¨×§ ×× allSites ×§×™×™×
          if (allSites && Array.isArray(allSites) && url && typeof url === 'string') {
            try {
              // × ×™×¡×™×•×Ÿ ×œ×—×œ×¥ ××ª ×©× ×”×“×•××™×™×Ÿ ××”-URL
              const domainMatch = url.match(/https?:\/\/([^\/\s]+)/);
              if (domainMatch && domainMatch[1]) {
                const hostname = domainMatch[1].toLowerCase();
                console.log('Attempting fallback with hostname:', hostname);

                return allSites.find(site => {
                  try {
                    if (!site?.URL || typeof site.URL !== 'string') return false;
                    const siteUrl = new URL(site.URL.trim());
                    return siteUrl.hostname.toLowerCase() === hostname;
                  } catch {
                    return false;
                  }
                });
              }
            } catch (fallbackError) {
              console.error('Fallback also failed:', fallbackError.message);
            }
          }

          return null;
        }
      }

      function handleSearchInput() {
        const query = searchInput.value.trim();
        if (query === '') {
          displayPopularSearches();
          if (clearSearch) clearSearch.style.display = 'none';
        } else {
          search(query);
          if (clearSearch) clearSearch.style.display = 'inline';
        }
      }

      function copyCurrentPageLink() {
        navigator.clipboard.writeText(window.location.href)
          .then(() => alert('×”×§×™×©×•×¨ ×”×•×¢×ª×§!'))
          .catch(() => alert('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×§×™×©×•×¨'));
      }

      function initializeSearch() {
        checkAndLogSource();
        const queryParam = getUrlParameter('query');
        const searchParam = getUrlParameter('search');

        if (queryParam) {
          searchInput.value = '';
          animateTyping(queryParam, () => {
            if (searchParam === 'true') {
              performPriceComparison(queryParam);
            }
          });
        } else {
          displayPopularSearches();
        }

        searchInput.addEventListener('input', handleSearchInput);

        if (clearSearch) {
          clearSearch.addEventListener('click', function () {
            searchInput.value = '';
            handleSearchInput();
            this.style.display = 'none';
          });
        }

        compareButton.addEventListener('click', () => performPriceComparison(currentSearchQuery));

        sortSelect.addEventListener('change', function () {
          const sortedResults = [...currentResults].sort((a, b) => {
            const priceA = parseFloat(a.price.replace(/[^\d.-]/g, ''));
            const priceB = parseFloat(b.price.replace(/[^\d.-]/g, ''));
            return this.value === 'price-asc' ? priceA - priceB : priceB - priceA;
          });
          displayComparisonResults(sortedResults);
        });
      }

      // ××ª×—×•×œ ×”×¢××•×“
      initializePageFromUrl();

      // ×˜×¢×™× ×ª × ×ª×•× ×™ ××ª×¨×™×
      fetch("https://o0rmue7xt0.execute-api.il-central-1.amazonaws.com/dev/sites")
        .then(response => response.json())
        .then(data => {
          allSites = data;
          initializeSearch();
        })
        .catch(error => console.error("Error fetching sites:", error));

      // ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª
      window.requestCoupon = requestCoupon;
      window.copyCoupon = copyCoupon;
      window.goToProduct = goToProduct;
      window.goToSite = goToSite;
      window.copyCurrentPageLink = copyCurrentPageLink;
    });
  </script>
  <div id="globeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm text-center relative min-h-[300px]"
      style="min-width: 300px;">
      <!-- ×›×¤×ª×•×¨ ××™×§×¡ -->
      <button id="closeGlobeModalBtn"
        class="absolute top-2 left-2 text-gray-500 hover:text-gray-700 text-xl font-bold">Ã—</button>

      <!-- ×× ×™××¦×™×™×ª ×’×œ×•×‘×•×¡ ×¢× ××¦×‘×¢ ××™××™×Ÿ -->
      <div class="relative flex justify-center items-center mb-6" style="height: 100px;">
        <!-- ×’×œ×•×‘×•×¡ -->
        <div id="globeIcon" class="text-[80px] animate-spin-slow z-10">ğŸŒ</div>

        <!-- ××¦×‘×¢ ××¦×‘×™×¢×” ××™××™×Ÿ -->
        <div id="globeFinger"
          class="absolute right-1/2 translate-x-20 top-1/2 -translate-y-1/2 text-[40px] transition-all duration-500 ease-out z-20">
          ğŸ‘ˆ
        </div>
      </div>

      <!-- ×©× ×¢×™×¨ ×¨× ×“×•××œ×™×ª ××—×¨×™ ×”×¢×¦×™×¨×” -->
      <!-- ×©× ×¢×™×¨ ×¨× ×“×•××œ×™×ª -->
      <div id="selectedCityText"
        class="text-lg font-semibold text-gray-800 mb-4 transition-opacity duration-300 opacity-100 h-6">
      </div>


      <!-- ×›×¤×ª×•×¨ ×¤×¢×•×œ×” -->
      <div class="flex justify-center items-center gap-2">
        <button id="globeActionBtn"
          class="bg-green-600 text-white px-4 py-2 rounded-full hover:bg-green-700 transition">
          ×¢×¦×•×¨
        </button>
        <button id="globeRefreshBtn" title="×‘×—×¨ ×™×¢×“ ×¨× ×“×•××œ×™ × ×•×¡×£"
          class="hidden text-gray-600 hover:text-green-600 text-xl">
          ğŸ”„
        </button>
      </div>
    </div>
  </div>




</body>

</html>
